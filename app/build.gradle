plugins {
    id 'com.android.application'
    id 'org.jetbrains.kotlin.android'
}

// Version bilgilerini dinamik olarak oluÅŸtur
def getVersionCode = {
    // Epoch time'Ä±n son 8 hanesini kullan (her build'de farklÄ±)
    // Bu ÅŸekilde Integer.MAX_VALUE (2,147,483,647) sÄ±nÄ±rÄ±nÄ± aÅŸmaz
    // Her saniye farklÄ± bir version code Ã¼retir
    def epochSeconds = (long)(System.currentTimeMillis() / 1000)
    // Son 8 haneyi al (maksimum: 99,999,999 - gÃ¼venli)
    return (int)(epochSeconds % 100000000)
}

def getVersionName = {
    // Timestamp'ten version name oluÅŸtur
    // Format: 1.0.YYMMDD-HHmm (Ã¶rn: 1.0.241215-1430)
    def date = new Date()
    def formattedDate = date.format('yyMMdd-HHmm')
    return "1.0.${formattedDate}"
}

android {
    namespace 'com.poolmod.menu'
    compileSdk 34

    defaultConfig {
        applicationId "com.poolmod.menu"
        minSdk 21
        targetSdk 34
        versionCode getVersionCode()
        versionName getVersionName()
    }

    buildTypes {
        release {
            minifyEnabled true
            shrinkResources true
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
        }
        debug {
            minifyEnabled false
        }
    }

    compileOptions {
        sourceCompatibility JavaVersion.VERSION_1_8
        targetCompatibility JavaVersion.VERSION_1_8
    }

    kotlinOptions {
        jvmTarget = '1.8'
    }
}

dependencies {
    implementation 'androidx.core:core-ktx:1.12.0'
    implementation 'androidx.appcompat:appcompat:1.6.1'
    implementation 'com.google.android.material:material:1.11.0'
    implementation 'androidx.constraintlayout:constraintlayout:2.1.4'
    implementation 'androidx.lifecycle:lifecycle-runtime-ktx:2.6.2'
    implementation 'androidx.lifecycle:lifecycle-service:2.6.2'
    implementation 'androidx.localbroadcastmanager:localbroadcastmanager:1.1.0'
}

// Build Ã¶ncesi eski APK'larÄ± temizle
task cleanOldApks(type: Delete) {
    delete fileTree(dir: "${project.buildDir}/outputs/apk", include: "*.apk")
    delete fileTree(dir: "${project.buildDir}/intermediates/apk", include: "*.apk")
    println "ðŸ§¹ Eski APK'lar temizlendi"
}

// Android plugin yÃ¼klendikten sonra task'larÄ± baÄŸla
afterEvaluate {
    // assembleDebug ve assembleRelease'den Ã¶nce cleanOldApks Ã§alÄ±ÅŸtÄ±r
    if (tasks.findByName('assembleDebug')) {
        tasks.assembleDebug.dependsOn cleanOldApks
    }
    if (tasks.findByName('assembleRelease')) {
        tasks.assembleRelease.dependsOn cleanOldApks
    }
    
    // Her build task'Ä±ndan Ã¶nce eski APK'larÄ± sil
    tasks.matching { it.name.startsWith('assemble') }.all { task ->
        task.doFirst {
            println "ðŸ§¹ Eski APK'lar temizleniyor..."
            delete fileTree(dir: "${project.buildDir}/outputs/apk", include: "*.apk")
            delete fileTree(dir: "${project.buildDir}/intermediates/apk", include: "*.apk")
            println "âœ… Eski APK'lar silindi - Yeni version: ${android.defaultConfig.versionName} (${android.defaultConfig.versionCode})"
        }
    }
}

